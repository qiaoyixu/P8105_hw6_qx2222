---
title: "P8105_hw6_qx2222"
author: "Qiaoyi Xu"
date: "2022-12-01"
output: github_document
---

```{r}
library(tidyverse)
library(modelr)
library(mgcv)
```

## Problem 1


## Problem 2

### Data import
```{r}
homicide = read_csv("data/homicide-data.csv") #import 'homicide' data
```

### Data cleaning
```{r}
homicide = homicide %>%
  mutate(city_state = str_c(city, ", ", state)) %>%
  mutate(homicide_status = if_else(disposition == "Closed without arrest", "unresolved",
                                   if_else(disposition == "Open/No arrest", "unresolved",
                                           if_else(disposition == "Closed by arrest", "resolved", NA_character_)))) %>%
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>% #omit observations
  filter(victim_race %in% c("Black", "White")) %>% #limit your analysis those for whom victim_race is white or black
  mutate(victim_age = as.numeric(victim_age)) %>% # Be sure that victim_age is numeric
  drop_na(victim_age)


homicide
```

### For the city of Baltimore, MD
```{r, warning=FALSE}
fit_log_MD = homicide %>% #use the glm function to fit a logistic regression
  filter(city_state == "Baltimore, MD") %>%
  mutate(homicide_status = fct_relevel(homicide_status, "resloved")) %>%
  glm(homicide_status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())%>%
  broom::tidy() %>%
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate - 1.96*std.error),
         CI_higher = exp(estimate + 1.96*std.error)) %>%
  select(term, estimate, OR, CI_lower, CI_higher) %>%
  knitr::kable(digits = 3, col.names = c("Term", "Estimate", "Odds ratio", "95CI_low","95CI_high"))

fit_log_MD
```


### Run glm for each of the cities
```{r}
homicide_cities = homicide %>% #use the glm function to fit a logistic regression
  mutate(homicide_status = fct_relevel(homicide_status, "resloved")) %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(.x = data, ~ glm(homicide_status ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    output = map (models, broom::tidy))%>%
  select(city_state, output) %>%
  unnest(output) %>%
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate - 1.96*std.error),
         CI_higher = exp(estimate + 1.96*std.error)) %>%
  select(city_state, term, estimate, OR, CI_lower, CI_higher) %>%
  filter(term == "victim_sexMale")

homicide_cities %>%
  knitr::kable(digits = 3, col.names = c("City, state", "Term", "Estimate", "Odds ratio", "95CI_low","95CI_high"))
```

### Create a plot that shows the estimated ORs and CIs for each city
```{r}
prob2_plot = homicide_cities %>%
  mutate(city_state = reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR))+
  geom_point(alpha = .5) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_higher))+
  labs(x = "City, state", y = "Odds Ratio",
       title = "The estimated ORs and CIs for each city") +
  theme(axis.text.x = element_text(angle = 90))

prob2_plot
```
```{r}
ggsave(
  filename = "results/plot for each city(problem 2).pdf",
  plot = prob2_plot,
  width = 30,
  height = 20,
  units = "cm"
  ) #export plot to 'results' directory
```


## Problem 3

### Load and clean the data 
```{r}
birthweight = read_csv("data/birthweight.csv") #import 'birthweight' data

birthweight
```

```{r}
birthweight = birthweight %>%
  mutate(babysex = as.factor(babysex),
         babysex = recode_factor(babysex, "1" = "Male", "2" = "Female"),
         frace = as.factor(frace),
         frace = recode_factor(frace, 
                               "1" = "White", "2" = "Black", "3" = "Asian", 
                               "4" = "Puerto Rican", "8" = "Other", "9" = "Unknown"),
         malform = as.factor(malform),
         malform = recode_factor(malform, "0" = "Absent", "1" = "Present"),
         mrace = as.factor(mrace),
         mrace = recode_factor(mrace, 
                               "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other"))

skimr::skim(birthweight) #check missing data

```

### Propose a regression model for birthweight

As we know, Genetics, age of the parent, Length of Pregnancy, Mother's habits, Baby's Gender, Ethnicity are important factors to influence baby's birth weight. Besides, I would like to focus on the mother's condition as factors in the influence of birthweight. So, I took them as predictors into my regression model, such as delwt, gaweeks, mheight, momage, mrace, smoken.

```{r}
birthweight_mymodel = lm(bwt ~ delwt + gaweeks + mheight + momage + mrace + smoken, data = birthweight)
  
birthweight_mymodel %>%
  broom::tidy() %>%
  knitr::kable(digits = 3)

```

### Create a plot of model residuals against fitted values 
```{r}
plot_residual_mymodel = birthweight %>%
  add_predictions(birthweight_mymodel)%>%
  add_residuals(birthweight_mymodel) %>%
  ggplot(aes(x = pred, y = resid, color = resid))+
  geom_point() +
  geom_smooth(se = F, color = "red", method = "lm")+
  labs(x = "Fitted values", y = "Residuals",
       title = "Residuals v.s. Fitted values") 

plot_residual_mymodel
  
```

```{r}
ggsave(
  filename = "results/residual v.s. Fitted Values of mymodel (problem 3).pdf",
  plot = plot_residual_mymodel,
  width = 30,
  height = 20,
  units = "cm"
  ) #export plot to 'results' directory
```

### Compare your model to two others
One using length at birth and gestational age as predictors (main effects only)
One using head circumference, length, sex, and all interactions (including the three-way interaction) between these
```{r}
cv_df = crossv_mc(birthweight,100) %>%
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(
    my_mod  = map(train, ~lm(bwt ~ delwt + gaweeks + mheight + momage + mrace + smoken, data = .x)),
    main_effect_mod  = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    interaction_mod  = map(train, ~lm(bwt ~ bhead + blength + babysex + 
                                        bhead*blength + bhead*babysex + blength*babysex + bhead*babysex +
                                        bhead*blength*babysex, data = .x))) %>%
  mutate(
    rmse_linear = map2_dbl(my_mod, test, ~rmse(model = .x, data = .y)),
    rmse_smooth = map2_dbl(main_effect_mod, test, ~rmse(model = .x, data = .y)),
    rmse_wiggly = map2_dbl(interaction_mod, test, ~rmse(model = .x, data = .y)))

```

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin()


```










