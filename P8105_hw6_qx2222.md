P8105_hw6_qx2222
================
Qiaoyi Xu
2022-12-01

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
    ## ✔ ggplot2 3.3.6      ✔ purrr   0.3.4 
    ## ✔ tibble  3.1.8      ✔ dplyr   1.0.10
    ## ✔ tidyr   1.2.0      ✔ stringr 1.4.1 
    ## ✔ readr   2.1.2      ✔ forcats 0.5.2 
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

## Problem 1

## Problem 2

### Data import

``` r
homicide = read_csv("data/homicide-data.csv") #import 'homicide' data
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

### Data cleaning

``` r
homicide = homicide %>%
  mutate(city_state = str_c(city, ", ", state)) %>%
  mutate(homicide_status = if_else(disposition == "Closed without arrest", "unresolved",
                                   if_else(disposition == "Open/No arrest", "unresolved",
                                           if_else(disposition == "Closed by arrest", "resolved", NA_character_)))) %>%
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>% #omit observations
  filter(victim_race %in% c("Black", "White")) %>% #limit your analysis those for whom victim_race is white or black
  mutate(victim_age = as.numeric(victim_age)) %>% # Be sure that victim_age is numeric
  drop_na(victim_age)
```

    ## Warning in mask$eval_all_mutate(quo): 强制改变过程中产生了NA

``` r
homicide
```

    ## # A tibble: 39,403 × 14
    ##    uid   repor…¹ victi…² victi…³ victi…⁴ victi…⁵ victi…⁶ city  state   lat   lon
    ##    <chr>   <dbl> <chr>   <chr>   <chr>     <dbl> <chr>   <chr> <chr> <dbl> <dbl>
    ##  1 Alb-…  2.01e7 SATTER… VIVIANA White        15 Female  Albu… NM     35.1 -107.
    ##  2 Alb-…  2.01e7 MULA    VIVIAN  White        72 Female  Albu… NM     35.1 -107.
    ##  3 Alb-…  2.01e7 BOOK    GERALD… White        91 Female  Albu… NM     35.2 -107.
    ##  4 Alb-…  2.01e7 MARTIN… GUSTAVO White        56 Male    Albu… NM     35.1 -107.
    ##  5 Alb-…  2.01e7 GRAY    STEFAN… White        43 Female  Albu… NM     35.1 -107.
    ##  6 Alb-…  2.01e7 DAVID   LARRY   White        52 Male    Albu… NM     NA     NA 
    ##  7 Alb-…  2.01e7 BRITO   ELIZAB… White        22 Female  Albu… NM     35.1 -107.
    ##  8 Alb-…  2.01e7 KING    TEVION  Black        15 Male    Albu… NM     35.1 -107.
    ##  9 Alb-…  2.01e7 BOYKIN  CEDRIC  Black        25 Male    Albu… NM     35.1 -107.
    ## 10 Alb-…  2.01e7 BARRAG… MIGUEL  White        20 Male    Albu… NM     35.1 -107.
    ## # … with 39,393 more rows, 3 more variables: disposition <chr>,
    ## #   city_state <chr>, homicide_status <chr>, and abbreviated variable names
    ## #   ¹​reported_date, ²​victim_last, ³​victim_first, ⁴​victim_race, ⁵​victim_age,
    ## #   ⁶​victim_sex

### For the city of Baltimore, MD

``` r
fit_log_MD = homicide %>% #use the glm function to fit a logistic regression
  filter(city_state == "Baltimore, MD") %>%
  mutate(homicide_status = fct_relevel(homicide_status, "resloved")) %>%
  glm(homicide_status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())%>%
  broom::tidy() %>%
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate - 1.96*std.error),
         CI_higher = exp(estimate + 1.96*std.error)) %>%
  select(term, estimate, OR, CI_lower, CI_higher) %>%
  knitr::kable(digits = 3, col.names = c("Term", "Estimate", "Odds ratio", "95CI_low","95CI_high"))
```

### Run glm for each of the cities

``` r
homicide_cities = homicide %>% #use the glm function to fit a logistic regression
  mutate(homicide_status = fct_relevel(homicide_status, "resloved")) %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(.x = data, ~ glm(homicide_status ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    output = map (models, broom::tidy))%>%
  select(city_state, output) %>%
  unnest(output) %>%
  mutate(OR = exp(estimate),
         CI_lower = exp(estimate - 1.96*std.error),
         CI_higher = exp(estimate + 1.96*std.error)) %>%
  select(city_state, term, estimate, OR, CI_lower, CI_higher) %>%
  filter(term == "victim_sexMale")
```

    ## Warning: 1 unknown level in `f`: resloved

``` r
homicide_cities %>%
  knitr::kable(digits = 3, col.names = c("City, state", "Term", "Estimate", "Odds ratio", "95CI_low","95CI_high"))
```

| City, state        | Term           | Estimate | Odds ratio | 95CI_low | 95CI_high |
|:-------------------|:---------------|---------:|-----------:|---------:|----------:|
| Albuquerque, NM    | victim_sexMale |   -0.570 |      0.566 |    0.266 |     1.204 |
| Atlanta, GA        | victim_sexMale |    0.000 |      1.000 |    0.683 |     1.463 |
| Baltimore, MD      | victim_sexMale |    0.854 |      2.350 |    1.793 |     3.081 |
| Baton Rouge, LA    | victim_sexMale |    0.964 |      2.622 |    1.438 |     4.779 |
| Birmingham, AL     | victim_sexMale |    0.139 |      1.149 |    0.759 |     1.741 |
| Boston, MA         | victim_sexMale |    0.395 |      1.484 |    0.784 |     2.809 |
| Buffalo, NY        | victim_sexMale |    0.653 |      1.921 |    1.069 |     3.451 |
| Charlotte, NC      | victim_sexMale |    0.123 |      1.131 |    0.713 |     1.795 |
| Chicago, IL        | victim_sexMale |    0.891 |      2.438 |    1.998 |     2.976 |
| Cincinnati, OH     | victim_sexMale |    0.917 |      2.501 |    1.477 |     4.236 |
| Columbus, OH       | victim_sexMale |    0.630 |      1.878 |    1.334 |     2.644 |
| Denver, CO         | victim_sexMale |    0.736 |      2.087 |    1.030 |     4.230 |
| Detroit, MI        | victim_sexMale |    0.541 |      1.717 |    1.363 |     2.164 |
| Durham, NC         | victim_sexMale |    0.208 |      1.231 |    0.594 |     2.551 |
| Fort Worth, TX     | victim_sexMale |    0.402 |      1.495 |    0.887 |     2.519 |
| Fresno, CA         | victim_sexMale |   -0.289 |      0.749 |    0.326 |     1.723 |
| Houston, TX        | victim_sexMale |    0.341 |      1.406 |    1.103 |     1.793 |
| Indianapolis, IN   | victim_sexMale |    0.085 |      1.088 |    0.805 |     1.472 |
| Jacksonville, FL   | victim_sexMale |    0.329 |      1.389 |    1.036 |     1.864 |
| Las Vegas, NV      | victim_sexMale |    0.178 |      1.194 |    0.867 |     1.646 |
| Long Beach, CA     | victim_sexMale |    0.891 |      2.438 |    0.924 |     6.430 |
| Los Angeles, CA    | victim_sexMale |    0.413 |      1.511 |    1.046 |     2.183 |
| Louisville, KY     | victim_sexMale |    0.712 |      2.039 |    1.266 |     3.282 |
| Memphis, TN        | victim_sexMale |    0.324 |      1.383 |    1.012 |     1.890 |
| Miami, FL          | victim_sexMale |    0.663 |      1.941 |    1.147 |     3.284 |
| Milwaukee, wI      | victim_sexMale |    0.319 |      1.375 |    0.943 |     2.005 |
| Minneapolis, MN    | victim_sexMale |    0.054 |      1.056 |    0.533 |     2.091 |
| Nashville, TN      | victim_sexMale |   -0.034 |      0.967 |    0.640 |     1.460 |
| New Orleans, LA    | victim_sexMale |    0.536 |      1.710 |    1.233 |     2.371 |
| New York, NY       | victim_sexMale |    1.338 |      3.811 |    2.003 |     7.249 |
| Oakland, CA        | victim_sexMale |    0.574 |      1.776 |    1.151 |     2.739 |
| Oklahoma City, OK  | victim_sexMale |    0.026 |      1.027 |    0.658 |     1.602 |
| Omaha, NE          | victim_sexMale |    0.961 |      2.614 |    1.387 |     4.927 |
| Philadelphia, PA   | victim_sexMale |    0.701 |      2.015 |    1.533 |     2.648 |
| Pittsburgh, PA     | victim_sexMale |    0.842 |      2.322 |    1.429 |     3.772 |
| Richmond, VA       | victim_sexMale |   -0.006 |      0.994 |    0.492 |     2.008 |
| San Antonio, TX    | victim_sexMale |    0.350 |      1.419 |    0.801 |     2.515 |
| Sacramento, CA     | victim_sexMale |    0.402 |      1.495 |    0.748 |     2.988 |
| Savannah, GA       | victim_sexMale |    0.143 |      1.153 |    0.562 |     2.368 |
| San Bernardino, CA | victim_sexMale |    0.692 |      1.999 |    0.684 |     5.841 |
| San Diego, CA      | victim_sexMale |    0.884 |      2.421 |    1.170 |     5.012 |
| San Francisco, CA  | victim_sexMale |    0.498 |      1.646 |    0.858 |     3.157 |
| St. Louis, MO      | victim_sexMale |    0.352 |      1.422 |    1.073 |     1.885 |
| Stockton, CA       | victim_sexMale |   -0.301 |      0.740 |    0.340 |     1.610 |
| Tampa, FL          | victim_sexMale |    0.214 |      1.238 |    0.533 |     2.876 |
| Tulsa, OK          | victim_sexMale |    0.025 |      1.025 |    0.644 |     1.630 |
| Washington, DC     | victim_sexMale |    0.371 |      1.449 |    0.983 |     2.135 |

### Create a plot that shows the estimated ORs and CIs for each city

``` r
prob2_plot = homicide_cities %>%
  mutate(city_state = reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR))+
  geom_point(alpha = .5) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_higher))+
  labs(x = "City, state", y = "Odds Ratio",
       title = "The estimated ORs and CIs for each city") +
  theme(axis.text.x = element_text(angle = 90))

prob2_plot
```

![](P8105_hw6_qx2222_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

``` r
ggsave(
  filename = "results/plot for each city(problem 2).pdf",
  plot = prob2_plot,
  width = 30,
  height = 20,
  units = "cm"
  ) #export plot to 'results' directory
```
